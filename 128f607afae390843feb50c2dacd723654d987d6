{
  "comments": [
    {
      "key": {
        "uuid": "75439b41_1d2551fa",
        "filename": "target/product/base_system.mk",
        "patchSetId": 1
      },
      "lineNbr": 329,
      "author": {
        "id": 1038443
      },
      "writtenOn": "2020-04-20T08:24:06Z",
      "side": 1,
      "message": "Ulya, can this be in PRODUCT_BOOT_JARS? The i18n module isn\u0027t updatable.",
      "range": {
        "startLine": 329,
        "startChar": 0,
        "endLine": 329,
        "endChar": 33
      },
      "revId": "128f607afae390843feb50c2dacd723654d987d6",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "03ba3766_610f4cfc",
        "filename": "target/product/base_system.mk",
        "patchSetId": 1
      },
      "lineNbr": 329,
      "author": {
        "id": 1550939
      },
      "writtenOn": "2020-04-20T09:01:53Z",
      "side": 1,
      "message": "We\u0027ll need to change format of PRODUCT_BOOT_JARS from a list of module names to a list of colon-separated pairs (apex name, module name). For platform modules that are not from apex we can have special apex name \"platform\".\n\nThe change is straightforward, potential problems are only for the products that append to PRODUCT_BOOT_JARS. We\u0027ll need to validate PRODUCT_BOOT_JARS to ensure that all components have the new colon-separated format. Still there will be partners who will be broken by this change (best we can do for them is to emit a clear error message).\n\nPersonally I\u0027d welcome the change as it will make the handling of PRODUCT_BOOT_JARS and PRODUCT_UPDATABLE_BOOT_JARS more uniform. I think it should be done before merging this CL. Should I start working on this immediately to unblock Victor\u0027s change?",
      "parentUuid": "75439b41_1d2551fa",
      "range": {
        "startLine": 329,
        "startChar": 0,
        "endLine": 329,
        "endChar": 33
      },
      "revId": "128f607afae390843feb50c2dacd723654d987d6",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ae4b25ec_df244cbb",
        "filename": "target/product/base_system.mk",
        "patchSetId": 1
      },
      "lineNbr": 329,
      "author": {
        "id": 1038443
      },
      "writtenOn": "2020-04-20T09:09:48Z",
      "side": 1,
      "message": "I think Victor can still land this change without your cleanup, but I agree we can work on the cleanup you are suggesting now.",
      "parentUuid": "03ba3766_610f4cfc",
      "range": {
        "startLine": 329,
        "startChar": 0,
        "endLine": 329,
        "endChar": 33
      },
      "revId": "128f607afae390843feb50c2dacd723654d987d6",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "d52d4952_0b08ac5d",
        "filename": "target/product/base_system.mk",
        "patchSetId": 1
      },
      "lineNbr": 329,
      "author": {
        "id": 1038443
      },
      "writtenOn": "2020-04-20T09:11:43Z",
      "side": 1,
      "message": "Actually, Victor could just put core-icu4j in PRODUCT_BOOT_JARS, right?",
      "parentUuid": "ae4b25ec_df244cbb",
      "range": {
        "startLine": 329,
        "startChar": 0,
        "endLine": 329,
        "endChar": 33
      },
      "revId": "128f607afae390843feb50c2dacd723654d987d6",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "54216b17_7a380aed",
        "filename": "target/product/base_system.mk",
        "patchSetId": 1
      },
      "lineNbr": 329,
      "author": {
        "id": 1550939
      },
      "writtenOn": "2020-04-20T09:21:20Z",
      "side": 1,
      "message": "\u003e I think Victor can still land this change without your cleanup, but I agree we can work on the cleanup you are suggesting now.\n\nOne undesirable effect will be that core-icu4j will no longer be in the framework boot image (possible performance regression).\n\n\u003e Actually, Victor could just put core-icu4j in PRODUCT_BOOT_JARS, right?\n\nFor all PRODUCT_BOOT_JARS that are not ART_APEX_JARS we assume on-device location /system/framework: https://source.corp.google.com/aosp-master/build/soong/java/dexpreopt_config.go;l\u003d113. So I think this will result in a boot failure due to not finding core-icu4j in /system/framework. I need to check this.",
      "parentUuid": "d52d4952_0b08ac5d",
      "range": {
        "startLine": 329,
        "startChar": 0,
        "endLine": 329,
        "endChar": 33
      },
      "revId": "128f607afae390843feb50c2dacd723654d987d6",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "8210f5e2_e6c7535c",
        "filename": "target/product/base_system.mk",
        "patchSetId": 1
      },
      "lineNbr": 329,
      "author": {
        "id": 1047684
      },
      "writtenOn": "2020-04-20T10:48:40Z",
      "side": 1,
      "message": "Just tried putting core-icu4j in PRODUCT_BOOT_JARS, and I got the following build error from build/soong/java/dexpreopt_bootjars.go.\n\n\u003e internal error: module \u0027core-icu4j\u0027 from updatable apex \u0027com.android.i18n\u0027 is not allowed in the framework boot image",
      "parentUuid": "54216b17_7a380aed",
      "range": {
        "startLine": 329,
        "startChar": 0,
        "endLine": 329,
        "endChar": 33
      },
      "revId": "128f607afae390843feb50c2dacd723654d987d6",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "2067606f_b28751f5",
        "filename": "target/product/base_system.mk",
        "patchSetId": 1
      },
      "lineNbr": 329,
      "author": {
        "id": 1038443
      },
      "writtenOn": "2020-04-20T11:09:50Z",
      "side": 1,
      "message": "Probably because you have the \"updatable\" bit in your apex definition?",
      "parentUuid": "8210f5e2_e6c7535c",
      "range": {
        "startLine": 329,
        "startChar": 0,
        "endLine": 329,
        "endChar": 33
      },
      "revId": "128f607afae390843feb50c2dacd723654d987d6",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "e88a677e_a7d023c5",
        "filename": "target/product/base_system.mk",
        "patchSetId": 1
      },
      "lineNbr": 329,
      "author": {
        "id": 1550939
      },
      "writtenOn": "2020-04-20T11:18:07Z",
      "side": 1,
      "message": "Right, this comes from a sanity check I recently added. The check assumes that that any apex which is updatable, so I need to investigate how to distinguish between updatable and non-updatable apexes.\n\nVictor, can this CL wait a few days until I do refactoring of PRODUCT_BOOT_JARS?",
      "parentUuid": "8210f5e2_e6c7535c",
      "range": {
        "startLine": 329,
        "startChar": 0,
        "endLine": 329,
        "endChar": 33
      },
      "revId": "128f607afae390843feb50c2dacd723654d987d6",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "cae2a73a_71575578",
        "filename": "target/product/base_system.mk",
        "patchSetId": 1
      },
      "lineNbr": 329,
      "author": {
        "id": 1550939
      },
      "writtenOn": "2020-04-20T11:21:50Z",
      "side": 1,
      "message": "\u003e Probably because you have the \"updatable\" bit in your apex definition?\n\nI think not, the check needs to be adjusted.",
      "parentUuid": "e88a677e_a7d023c5",
      "range": {
        "startLine": 329,
        "startChar": 0,
        "endLine": 329,
        "endChar": 33
      },
      "revId": "128f607afae390843feb50c2dacd723654d987d6",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "4a8a22d2_30c62fd0",
        "filename": "target/product/base_system.mk",
        "patchSetId": 1
      },
      "lineNbr": 329,
      "author": {
        "id": 1047684
      },
      "writtenOn": "2020-04-20T11:22:22Z",
      "side": 1,
      "message": "Yeah. I can wait a few days because I am still trying to resolve the build failures in other downstream branches and causing presubmit failures.\n\nhttps://android.googlesource.com/platform/libcore/+/refs/changes/21/1283721/1/apex/Android.bp\nI don\u0027t specify \u0027updatable\u0027 bit in the apex definition. go/android.bp tells me that the default is false.",
      "parentUuid": "e88a677e_a7d023c5",
      "range": {
        "startLine": 329,
        "startChar": 0,
        "endLine": 329,
        "endChar": 33
      },
      "revId": "128f607afae390843feb50c2dacd723654d987d6",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "89356a25_28f7914c",
        "filename": "target/product/base_system.mk",
        "patchSetId": 1
      },
      "lineNbr": 329,
      "author": {
        "id": 1550939
      },
      "writtenOn": "2020-04-23T15:39:10Z",
      "side": 1,
      "message": "Update on my ongoing refactoring of PRODUCT_BOOT_JARS: the first CL http://ag/11212475 is on the way (still in review and may need some rework and a cherry-pick in AOSP), the second CL https://r.android.com/1292917 is also on the way.\n\nI cherry-picked both above CLs and the current CL, changed it to put core-icu4j on the non-updatable boot jar list, built aosp_walleye-userdebug and booted. Boot takes a long time and dex2oat is recompiling the world.\n\nOne possible problem is that we now have different DEX location for core-icu4j.jar (/apex/com.android.i18n/javalib/core-icu4j.jar), and the actual location of the boot image (/system/framework/arm64/boot-core-icu4j.art ...). I think this is a problem for dex2oat as it derives .art/.oat location from the DEX location. I think that ART supports BCP components of the same boot image in different locations, but even so I need to do more work in Soong to put boot-core-icu4j.{art,oat} in the right location.\n\nAlso, I\u0027m getting there warnings in logcat:\n\n  zygote64: Core platform API violation: Ljava/nio/charset/CharsetEncoder;-\u003e\u003cinit\u003e(Ljava/nio/charset/Charset;FF[BZ)V from /apex/com.android.i18n/javalib/core-icu4j.jar using linking",
      "parentUuid": "4a8a22d2_30c62fd0",
      "range": {
        "startLine": 329,
        "startChar": 0,
        "endLine": 329,
        "endChar": 33
      },
      "revId": "128f607afae390843feb50c2dacd723654d987d6",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    }
  ]
}