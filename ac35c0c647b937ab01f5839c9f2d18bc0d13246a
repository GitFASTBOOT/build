{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "70e68bc2_f511daa5",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 5
      },
      "lineNbr": 0,
      "author": {
        "id": 1514900
      },
      "writtenOn": "2023-04-03T08:40:27Z",
      "side": 1,
      "message": "I am not familiar with the contents or runtime deps of the *ts zips. What causes the duplication of files? Is that something that we can fix much earlier on in the build?\n\nI see that you\u0027re deduplicating the files by checksum. Would there be any potential filepath-based errors at runtime, say missing file at the expected location?",
      "revId": "ac35c0c647b937ab01f5839c9f2d18bc0d13246a",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4db79cbf_528287df",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 5
      },
      "lineNbr": 0,
      "author": {
        "id": 1897543
      },
      "writtenOn": "2023-04-04T01:33:02Z",
      "side": 1,
      "message": "A (CTS module) depends on B (CTS data), in today\u0027s CTS, there will be a folder called A, and for example, A.apk and B.apk will be put into the A folder. However, if B is also tagged as \u0027cts\u0027 in the test_suites field, then there will be another folder, called B, and B.apk will also be put into the B folder. In the cases, B occurs two times!\n\nTo fix it earlier in the build, one solution could be that remove unnecessary cts tags, but it takes time to roll out. We want to reduce the size in U, so the very short term solution is to remove duplicate files when zipping which is more safe.\n\nWe have done experiment and no such failures (file not found) have been found.",
      "parentUuid": "70e68bc2_f511daa5",
      "revId": "ac35c0c647b937ab01f5839c9f2d18bc0d13246a",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b0527ecb_d5ea5097",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 5
      },
      "lineNbr": 0,
      "author": {
        "id": 1514900
      },
      "writtenOn": "2023-04-05T05:35:24Z",
      "side": 1,
      "message": "Thank you for the explanation.\n\nOne thing I don\u0027t quite understand is if you deduplicate B by removing A/B.apk, why doesn\u0027t that cause A to fail? If it doesn\u0027t fail, doesn\u0027t it mean that A doesn\u0027t need B?\n\nWouldn\u0027t the more principled fix is to fix the Android.bp dependencies instead of doing this potentially unsafe optimization by removing test runfiles at the end of the build?",
      "parentUuid": "4db79cbf_528287df",
      "revId": "ac35c0c647b937ab01f5839c9f2d18bc0d13246a",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6eeb7109_b49ce052",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 5
      },
      "lineNbr": 0,
      "author": {
        "id": 1480888
      },
      "writtenOn": "2023-04-05T22:40:33Z",
      "side": 1,
      "message": "Could you explain why you\u0027re making this change? I checked the bug and didn\u0027t find any information.\n\nIs it an optimization? If so, why? Could you please list a few of these duplicate files to sanity check the result? What\u0027s the impact on the zip/build/etc of removing these duplicates?\n\nIIUC, the duplicate files are there to ensure that every test module has its dependencies. This allows us to run a single module without having to download the entire zip.\n\nInternally, we don\u0027t have much of an issue downloading the files because we do so with CAS.\n\nThat being said, the size of the zip can be trimmed by changing the format to list file blobs and referencing them. Alternatively the zip symlink feature might be useful. Again, it might be overkill for the problem you\u0027re solving.",
      "revId": "ac35c0c647b937ab01f5839c9f2d18bc0d13246a",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9db1ff99_37a2798f",
        "filename": "tools/Android.bp",
        "patchSetId": 5
      },
      "lineNbr": 89,
      "author": {
        "id": 1514900
      },
      "writtenOn": "2023-04-05T05:35:24Z",
      "side": 1,
      "message": "Can you add tests? (don\u0027t do this yet, until we resolve the safety/correctness discussion)",
      "range": {
        "startLine": 89,
        "startChar": 0,
        "endLine": 89,
        "endChar": 18
      },
      "revId": "ac35c0c647b937ab01f5839c9f2d18bc0d13246a",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "52ea106a_d096ff45",
        "filename": "tools/list_xts_files.py",
        "patchSetId": 5
      },
      "lineNbr": 22,
      "author": {
        "id": 1514900
      },
      "writtenOn": "2023-04-05T05:35:24Z",
      "side": 1,
      "message": "I recommend calling this \"deduplicate_test_runfiles.py\". It doesn\u0027t just list files, which is a side-effect-free action.",
      "range": {
        "startLine": 22,
        "startChar": 2,
        "endLine": 22,
        "endChar": 15
      },
      "revId": "ac35c0c647b937ab01f5839c9f2d18bc0d13246a",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}