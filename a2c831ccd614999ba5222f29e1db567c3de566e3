{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "04b10852_0c61ea04",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 9,
      "author": {
        "id": 1550939
      },
      "writtenOn": "2021-04-27T14:50:38Z",
      "side": 1,
      "message": "To clarify, if another boot jar from PRODUCT_BOOT_JARS moves to an apex, it won\u0027t be a problem, we\u0027ll have to move it after core-icu4j.jar, right?\n\nHow will we know about it -- will the build break, or will the device fail to boot?",
      "range": {
        "startLine": 9,
        "startChar": 31,
        "endLine": 9,
        "endChar": 58
      },
      "revId": "a2c831ccd614999ba5222f29e1db567c3de566e3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6c387844_dd95f370",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 9,
      "author": {
        "id": 1061164
      },
      "writtenOn": "2021-04-27T15:08:42Z",
      "side": 1,
      "message": "Note that this is not part of an _updatable_ module. All updatable apex jars go into PRODUCT_UPDATABLE_BOOT_JARS (except art).\n\nIn general, there was a request to have following ordering:\n\n1. ART jars\n2. /system jars\n3. /apex jars\n4. /system_ext, etc.\n\nART_APEX_JARS are special cased and live above everything else, given that icu4j was part of ART, I moved it here as well, but happy to put below /system jars just like any other existing apex. In fact maybe we should?\n\nAny other boot jar moving into apex would have to be in the (3) category. At runtime we\u0027ll do the right thing. Nothing exists to check any of this at build time, but with Paul\u0027s work we are also changing how we even define these... with introduction of bootclasspath_fragments and platform_bootclasspath_fragments we could do more at build time probably.",
      "parentUuid": "04b10852_0c61ea04",
      "range": {
        "startLine": 9,
        "startChar": 31,
        "endLine": 9,
        "endChar": 58
      },
      "revId": "a2c831ccd614999ba5222f29e1db567c3de566e3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "feab2c41_73e23a85",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 9,
      "author": {
        "id": 1550939
      },
      "writtenOn": "2021-04-27T16:01:55Z",
      "side": 1,
      "message": "My question was, if some system jar from PRODUCT_BOOT_JARS moves to a non-updatable apex, will that be a problem, and if yes, how will it manifest? Maybe we should have a build system check in the makefile to fail if one of the (non-updatable) apex jars in PRODUCT_BOOT_JARS is higher on the list than system jars?\n\nMaybe this was missing from the original ordering request, but it seems that:\n- non-updatable apex jars in PRODUCT_BOOT_JARS should be grouped at the end\n- derive_classpath should have some logic to walk non-updatable apexes before updatable ones\n\nOr else, how will derive_classpath know to insert icu4j before updatable apex jars?\n\n\u003e At runtime we\u0027ll do the right thing.\n\nCan you explain this a bit?",
      "parentUuid": "6c387844_dd95f370",
      "range": {
        "startLine": 9,
        "startChar": 31,
        "endLine": 9,
        "endChar": 58
      },
      "revId": "a2c831ccd614999ba5222f29e1db567c3de566e3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e5af0b5f_090d5b21",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 9,
      "author": {
        "id": 1061164
      },
      "writtenOn": "2021-04-27T16:20:05Z",
      "side": 1,
      "message": "Will we mandate bootclasspath_fragment{} definitions to exist for non-updatable apex? Probably yes, and I believe this is what Paul is going to do at some point. bootclasspath_fragment{} would then generate apex\u0027s classpaths.proto config.\n\nFrom my perspective I\u0027d say we should treat them as any other apex jars, let them have their own config and put them after /system jars in derive_classpath. Once that new apex decides to be updatable -- i.e. the ordering will not be a surprise for them. They would also have time to measure any system health regressions if any.\n\nWith this perspective, I\u0027d love to not treat icu4j specially in derive_classpath.\n\nOne of the meaningful difference is that updatable jars are not part of DEX2OATBOOTCLASSPATH, and I believe that should stay the same.\n\nderive_classpath already knows to insert art jars above system, we can just add a glob pattern right betwen art and system. (or we could skip that and icu4j would come after system once it has its own config.)",
      "parentUuid": "feab2c41_73e23a85",
      "range": {
        "startLine": 9,
        "startChar": 31,
        "endLine": 9,
        "endChar": 58
      },
      "revId": "a2c831ccd614999ba5222f29e1db567c3de566e3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e1849e0e_0546d151",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 9,
      "author": {
        "id": 1550939
      },
      "writtenOn": "2021-04-27T16:36:38Z",
      "side": 1,
      "message": "What we need to ensure is that the resulting bootclasspath does not put icu4j after some updatable jars -- that would invalidate framework boot image extension, because icu4j is part of it, unlike updatable jars (I expect the device would fail to boot).\n\nAside from that restriction, it can go before or after system jars, whichever is easier for you (provided that the order is always the same).\n\nI think that some special handling is needed in derive_classpath to put non-updatable apex jars before the updatable ones (or before system jars) on the resulting bootclasspath, but I don\u0027t see it in the current CL (is it intended as a follow-up?).",
      "parentUuid": "e5af0b5f_090d5b21",
      "range": {
        "startLine": 9,
        "startChar": 31,
        "endLine": 9,
        "endChar": 58
      },
      "revId": "a2c831ccd614999ba5222f29e1db567c3de566e3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2d92bfbc_d6b4f857",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 9,
      "author": {
        "id": 1061164
      },
      "writtenOn": "2021-04-27T16:45:43Z",
      "side": 1,
      "message": "I see.. that\u0027s the kind of details I was hoping to see :-)\n\nNote that derive_classpath is only reading one config in /system that contains all apexes as well, soong changes are incoming. This change (and the next follow up one) should be safe with that regard.\n\nNow, for the ordering of updatable / non-updatable. To summarize, we want:\n1. ART jars\n2. System jars\n3. Non updatable apex jars\n4. Updatable apex jars\n5. system_ext jars\n\nDoes the above seem reasonable? Maybe we could (as you mentioned) combine 3 and 4 at build time and put them into /system config; this way we minimize required logic (and thus potential risk of bugs) on the device side. Soong already knows this information, so combining them should be doable...\n\nThe implication is that the ordering on BCP would change when the apex decides to be updatable, but that shouldn\u0027t be a surprize if they have to modify this file anyhow.\n\nI\u0027ll update this cl tomorrow.",
      "parentUuid": "e1849e0e_0546d151",
      "range": {
        "startLine": 9,
        "startChar": 31,
        "endLine": 9,
        "endChar": 58
      },
      "revId": "a2c831ccd614999ba5222f29e1db567c3de566e3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b48506aa_7e70ae9e",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 9,
      "author": {
        "id": 1550939
      },
      "writtenOn": "2021-04-28T10:57:30Z",
      "side": 1,
      "message": "\u003e I see.. that\u0027s the kind of details I was hoping to see :-)\n\nSorry if I confused you, this is definitely not on purpose. :) \n\n\u003e To summarize, we want\n\nNot quite, we want:\n\n1. ART jars\n2. System jars\n3. system_ext jars\n4. Non updatable apex jars\n5. Updatable apex jars\n\nThe idea here is that system_ext is built together with system and may have boot jars that go in the framework boot image extension, so they need to go before updatable apex jars (they may go after non-updatable apex jars however). \n\nAs I gathered from discussion in https://android-review.googlesource.com/c/platform/packages/modules/SdkExtensions/+/1664905/3..11/derive_classpath/derive_classpath.cpp#b46, not doing any special handling for system_ext will result in the above order. Am I wrong?\n\nTo clarify, in the linked discussion we considered the possibility of unbundled system_ext, but now we decided that it\u0027s not supported --- hence the assumption that system_ext is always built with system and may contain boot jars that go in the boot image.\n\n\n\u003e The implication is that the ordering on BCP would change when the apex decides to be updatable, but that shouldn\u0027t be a surprize if they have to modify this file anyhow.\n\nYes, and if that happens, the jar in question will be excluded from the boot image, so it will have to be recompiled.",
      "parentUuid": "2d92bfbc_d6b4f857",
      "range": {
        "startLine": 9,
        "startChar": 31,
        "endLine": 9,
        "endChar": 58
      },
      "revId": "a2c831ccd614999ba5222f29e1db567c3de566e3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "5d87f57c_38b0209b",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 9,
      "author": {
        "id": 1061164
      },
      "writtenOn": "2021-04-28T12:29:48Z",
      "side": 1,
      "message": "Not your fault, I didn\u0027t realize that updatable jars must come after _all_ non-updatable jars, and was blindly following security team\u0027s advise.\n\nAdded some comments in the file. Ideally, with Paul\u0027s work progressing further, we would remove this and move the logic to soong eventually.\n\nNote that in the latest patch icu4j comes after system jars.\n\nI am still not fully aware on how system_ext jars gets introduced, perhaps we need to update some other comments / instructions? At the least I will introduce a CTS test to test the above ordering in a follow up.",
      "parentUuid": "b48506aa_7e70ae9e",
      "range": {
        "startLine": 9,
        "startChar": 31,
        "endLine": 9,
        "endChar": 58
      },
      "revId": "a2c831ccd614999ba5222f29e1db567c3de566e3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "dfd5651f_dc83f3cb",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 9,
      "author": {
        "id": 1550939
      },
      "writtenOn": "2021-04-28T12:45:47Z",
      "side": 1,
      "message": "\u003e I am still not fully aware on how system_ext jars gets introduced\n\nOne would add \"system_ext:some-jar-name\" to PRODUCT_BOOT_JARS.\n\n\u003e Added some comments in the file.\n\nVery helpful, thanks!\n\n\u003e At the least I will introduce a CTS test to test the above ordering in a follow up.\n\nThat would be great.",
      "parentUuid": "5d87f57c_38b0209b",
      "range": {
        "startLine": 9,
        "startChar": 31,
        "endLine": 9,
        "endChar": 58
      },
      "revId": "a2c831ccd614999ba5222f29e1db567c3de566e3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "2e9015f8_5b597c92",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1550939
      },
      "writtenOn": "2021-04-27T14:50:38Z",
      "side": 1,
      "message": "Adding Nicolas to verify that the relative order of boot jars in PRODUCT_BOOT_JARS doesn\u0027t matter.",
      "revId": "a2c831ccd614999ba5222f29e1db567c3de566e3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "431328a2_3a9bf3e7",
        "filename": "target/product/default_art_config.mk",
        "patchSetId": 2
      },
      "lineNbr": 21,
      "author": {
        "id": 1550939
      },
      "writtenOn": "2021-04-27T14:50:38Z",
      "side": 1,
      "message": "Can you expand this comment to say that all apex boot jars must go before other (system or system_ext) jars, and why?",
      "range": {
        "startLine": 21,
        "startChar": 0,
        "endLine": 21,
        "endChar": 57
      },
      "revId": "a2c831ccd614999ba5222f29e1db567c3de566e3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "50d46252_51b4e0ce",
        "filename": "target/product/default_art_config.mk",
        "patchSetId": 2
      },
      "lineNbr": 21,
      "author": {
        "id": 1061164
      },
      "writtenOn": "2021-04-27T15:08:42Z",
      "side": 1,
      "message": "That\u0027s not true actually, apex jars should generally go into PRODUCT_UPDATABLE_BOOT_JARS below. Ideally, ART_APEX_JARS would not be part of PRODUCT_BOOT_JARS, but for historic reasons they are. \n\nToday, PRODUCT_BOOT_JARS ordering matters because it defines relative ordering of /system/ jars in BCP, but I am trying to modularize that config, so as a follow up I\u0027ll add a special case for icu4j in derive_classpath to load after ART jars.\n\n(Unless we decide there is nothing special about icu4j and it should be part of all other normal apex jars.)",
      "parentUuid": "431328a2_3a9bf3e7",
      "range": {
        "startLine": 21,
        "startChar": 0,
        "endLine": 21,
        "endChar": 57
      },
      "revId": "a2c831ccd614999ba5222f29e1db567c3de566e3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "e42db445_cbbb8324",
        "filename": "target/product/default_art_config.mk",
        "patchSetId": 2
      },
      "lineNbr": 21,
      "author": {
        "id": 1550939
      },
      "writtenOn": "2021-04-27T16:01:55Z",
      "side": 1,
      "message": "One correction: *updatable* apex jars should go in PRODUCT_UPDATABLE_BOOT_JARS. Non-updatable apex jars should go in PRODUCT_BOOT_JARS, like icu4j.",
      "parentUuid": "50d46252_51b4e0ce",
      "range": {
        "startLine": 21,
        "startChar": 0,
        "endLine": 21,
        "endChar": 57
      },
      "revId": "a2c831ccd614999ba5222f29e1db567c3de566e3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}