{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "cd174888_94033d88",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 11,
      "author": {
        "id": 1060959
      },
      "writtenOn": "2021-02-03T16:15:18Z",
      "side": 1,
      "message": "- This mk updatable_apex.mk is meant for device builds\n- `lunch` also configures the build system for device builds\n- module_* products are not meant to be lunched. We could add an error for that\n\nLooking at the bug, I\u0027d argue this is user error",
      "range": {
        "startLine": 11,
        "startChar": 6,
        "endLine": 11,
        "endChar": 48
      },
      "revId": "8dbd179260432367aa9d506705c74fc4f70056e8",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c3f39205_bc136196",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 11,
      "author": {
        "id": 1373864
      },
      "writtenOn": "2021-02-03T16:31:24Z",
      "side": 1,
      "message": "1. I regard lunch as a way to set up the build environment for local use. In this case it\u0027s for building a module to be adb install\u0027ed. Why shouldn\u0027t that work?\n\n2. Irrespective of lunch\u0027ing, it makes no sense that module_* products build flattened APEXes. We could also set TARGET_FLATTEN_APEX:\u003dfalse here rather than including updatable_apex.mk, but I figured it\u0027d be good to have one place for it, and that the other stuff in there doesn\u0027t matter for the APEXes.",
      "parentUuid": "cd174888_94033d88",
      "range": {
        "startLine": 11,
        "startChar": 6,
        "endLine": 11,
        "endChar": 48
      },
      "revId": "8dbd179260432367aa9d506705c74fc4f70056e8",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b6882074_efa258bc",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 11,
      "author": {
        "id": 1060959
      },
      "writtenOn": "2021-02-03T17:24:45Z",
      "side": 1,
      "message": "\u003e 1. I regard lunch as a way to set up the build environment for local use. In this case it\u0027s for building a module to be adb install\u0027ed. Why shouldn\u0027t that work?\n\nIt just isn\u0027t how the build system works. lunch configures it to build a device, tapas configures it to build something unbundled\n\n\u003e \n\u003e 2. Irrespective of lunch\u0027ing, it makes no sense that module_* products build flattened APEXes.\n\nmodule_* products don\u0027t do that. lunching a product that isn\u0027t meant to be lunched does that\n\nYes, we could set the flag, but that would only fix the first of the problems Alex will see. Next, there\u0027ll be other weird things going on such as symlinks being added etc. I think we should fix lunch to not allow this instead",
      "parentUuid": "c3f39205_bc136196",
      "range": {
        "startLine": 11,
        "startChar": 6,
        "endLine": 11,
        "endChar": 48
      },
      "revId": "8dbd179260432367aa9d506705c74fc4f70056e8",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c1252a99_f5ec5107",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 11,
      "author": {
        "id": 1373864
      },
      "writtenOn": "2021-02-03T21:12:59Z",
      "side": 1,
      "message": "Ok, so it\u0027s tapas we should use instead. That\u0027s fine, but we\u0027ll need to extend it to specify module products at https://cs.android.com/android/platform/superproject/+/master:build/make/envsetup.sh;l\u003d763-768;drc\u003d24c36dbeecf4398c4da8901a047f9708676f3d9b and https://cs.android.com/android/platform/superproject/+/master:build/soong/ui/build/config.go;l\u003d681;drc\u003d6e49493dac7647c1d078f6a780db0993933fc94d\n\n\u003e module_* products don\u0027t do that. lunching a product that isn\u0027t meant to be lunched does that\n\nNot really, but it is true that TARGET_BUILD_APPS overrides TARGET_FLATTEN_APEX here: https://cs.android.com/android/platform/superproject/+/master:build/soong/apex/apex.go;l\u003d1916;drc\u003da1d6025a49bb7293885e5a9fcbd63a02d67e95d8 so using TBA, as tapas does, seemingly avoids the issue. I\u0027m a bit suspicious about that happening at that low level, rather than letting TBA control the default value of TFA in make.\n\nMaybe that can be done, but until then I think there\u0027s good reason to make sure TFA isn\u0027t true anywhere for these products.",
      "parentUuid": "b6882074_efa258bc",
      "range": {
        "startLine": 11,
        "startChar": 6,
        "endLine": 11,
        "endChar": 48
      },
      "revId": "8dbd179260432367aa9d506705c74fc4f70056e8",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "26dd22c3_111f4a9b",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 11,
      "author": {
        "id": 1060959
      },
      "writtenOn": "2021-02-04T10:26:17Z",
      "side": 1,
      "message": "- I\u0027d be okay with putting TARGET_FLATTEN_APEX:\u003dfalse in the BoardConfig of these devices, though doesn\u0027t seem important\n- More important IMO: make `lunch module_*` fail\n- Yes, tapas needs to be revamped to work properly for modules. I would like someone in the soong team to own that work rather than us",
      "parentUuid": "c1252a99_f5ec5107",
      "range": {
        "startLine": 11,
        "startChar": 6,
        "endLine": 11,
        "endChar": 48
      },
      "revId": "8dbd179260432367aa9d506705c74fc4f70056e8",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9e887fea_90f251c3",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 11,
      "author": {
        "id": 1373864
      },
      "writtenOn": "2021-02-04T13:19:17Z",
      "side": 1,
      "message": "\u003e I\u0027d be okay with putting TARGET_FLATTEN_APEX:\u003dfalse in the BoardConfig of these devices, though doesn\u0027t seem important\n\nI agree, it\u0027s less important since with TBA we get a .apex file anyway. But I\u0027d feel more comfortable having TFA false globally rather than relying on that single condition deep down in Soong - seems like a recipe for confusion and bugs that TFA is true when in fact it\u0027s not being flattened.\n\nSo I should change this CL to put TARGET_FLATTEN_APEX:\u003dfalse in the BoardConfigs instead then, without including updatable_apex.mk?\n\n\u003e More important IMO: make `lunch module_*` fail\n\u003e Yes, tapas needs to be revamped to work properly for modules. \n\nWe need to be able to specify products to tapas, not just architectures. So maybe a flag, say PRODUCT_UNBUNDLED\u003d{true,false}, that allows the product to be used with tapas but not lunch?",
      "parentUuid": "26dd22c3_111f4a9b",
      "range": {
        "startLine": 11,
        "startChar": 6,
        "endLine": 11,
        "endChar": 48
      },
      "revId": "8dbd179260432367aa9d506705c74fc4f70056e8",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f21c1172_4581304f",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 11,
      "author": {
        "id": 1060959
      },
      "writtenOn": "2021-02-04T15:35:00Z",
      "side": 1,
      "message": "\u003e We need to be able to specify products to tapas, not just architectures\n\nFor art_module_* I guess? maybe -- it\u0027d be nice to build out tapas sufficiently that it is smart and does the right thing by default when you try to build an apex. Or perhaps a new alias (pintxos? ;D) to build apexes\n\n\u003e maybe a flag, say PRODUCT_UNBUNDLED\u003d{true,false}, that allows the product to be used with tapas but not lunch?\n\nI like it",
      "parentUuid": "9e887fea_90f251c3",
      "range": {
        "startLine": 11,
        "startChar": 6,
        "endLine": 11,
        "endChar": 48
      },
      "revId": "8dbd179260432367aa9d506705c74fc4f70056e8",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "bc56e12f_4a33e37e",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 11,
      "author": {
        "id": 1373864
      },
      "writtenOn": "2021-02-04T16:04:45Z",
      "side": 1,
      "message": "I hope we can drop art_module_* later when there are better tools for deciding what to build from source, but for now, yes.\n\nI don\u0027t mind adding smartness to tapas, but I prefer to address that separately - first we need to extend it to be able to specify a product, then we can make it smarter so we don\u0027t have to.\n\nFor the first part it seems straightforward enough to extend the current arch argument to allow it to be a product (which has PRODUCT_UNBUNDLED\u003dtrue, then), and if it\u0027s just an arch it prepends \"aosp_\" just like today.",
      "parentUuid": "f21c1172_4581304f",
      "range": {
        "startLine": 11,
        "startChar": 6,
        "endLine": 11,
        "endChar": 48
      },
      "revId": "8dbd179260432367aa9d506705c74fc4f70056e8",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "f744692a_98fd4db1",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1060959
      },
      "writtenOn": "2021-02-04T15:35:00Z",
      "side": 1,
      "message": "+colin/liz, tapas for thought",
      "revId": "8dbd179260432367aa9d506705c74fc4f70056e8",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}