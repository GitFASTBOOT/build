{
  "comments": [
    {
      "key": {
        "uuid": "6764bc8d_839e78c7",
        "filename": "target/board/BoardConfigEmuCommon.mk",
        "patchSetId": 17
      },
      "lineNbr": 25,
      "author": {
        "id": 1046320
      },
      "writtenOn": "2019-04-12T14:50:02Z",
      "side": 1,
      "message": "bowgo:\n   is it ok to set AB_OTA_UPDATER to false ? I assume the BOARD_EXT4_SHARE_DUP_BLOCKS is required by dynamic partition support.",
      "range": {
        "startLine": 24,
        "startChar": 0,
        "endLine": 25,
        "endChar": 35
      },
      "revId": "e663686b60d15504861740b0a1e0397e40759ae7",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "6c39b8be_e3d70521",
        "filename": "target/board/BoardConfigEmuCommon.mk",
        "patchSetId": 17
      },
      "lineNbr": 25,
      "author": {
        "id": 1080813
      },
      "writtenOn": "2019-04-12T16:15:39Z",
      "side": 1,
      "message": "No, AB_OTA_UPDATER needs to be kept.\n\nOtherwise, after flashing GSI on a A/B device + a few reboots, there is no update_engine to update A/B slot status \u003d\u003d\u003e bootloader will think the current slot not bootable.\nSee b/111778046#comment3 for details.\n\nOTOH, we\u0027ll not run update_engine on a non-A/B device:\nhttps://android-review.googlesource.com/c/platform/system/update_engine/+/567122\n\n\nNot sure will BOARD_EXT4_SHARE_DUP_BLOCKS be \u0027required\u0027 for DAP.\nBut it seems a good feature (can reduce image size?) so probably ok to enable it.",
      "parentUuid": "6764bc8d_839e78c7",
      "range": {
        "startLine": 24,
        "startChar": 0,
        "endLine": 25,
        "endChar": 35
      },
      "revId": "e663686b60d15504861740b0a1e0397e40759ae7",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "a6225c18_c8493a16",
        "filename": "target/board/BoardConfigEmuCommon.mk",
        "patchSetId": 17
      },
      "lineNbr": 25,
      "author": {
        "id": 1046320
      },
      "writtenOn": "2019-04-12T16:25:30Z",
      "side": 1,
      "message": "AB_OTA_UPDATER :\u003d true is making lpmake think that the device is AB and leading to boot failure\n\n[    1.152893] init: [libfs_mgr]Created logical partition system_a on device /dev/block/dm-0\n[    1.155010] init: [libfs_mgr]Skipping zero-length logical partition: system_b\n[    1.168029] init: [libfs_mgr]Created logical partition vendor_a on device /dev/block/dm-1\n[    1.170591] init: [libfs_mgr]Skipping zero-length logical partition: vendor_b\n[    1.172623] init: DM_DEV_STATUS failed for system: No such device or address\n[    1.174665] init: Failed to mount /system: No such device or address\n\n \"lpmake --metadata-size 65536 --super-name super --metadata-slots 2 --device super:8145338368 --group emulator_dynamic_partitions_a:4068474880 --group emulator_dynamic_partitions_b:4068474880 --partition system_a:readonly:1002172416:emulator_dynamic_partitions_a --image system_a\u003dout/target/product/generic_x86_arm/system.img --partition system_b:readonly:0:emulator_dynamic_partitions_b --partition vendor_a:readonly:60039168:emulator_dynamic_partitions_a --image vendor_a\u003dout/target/product/generic_x86_arm/vendor.img --partition vendor_b:readonly:0:emulator_dynamic_partitions_b --sparse --output out/target/product/generic_x86_arm/super.img\"",
      "parentUuid": "6c39b8be_e3d70521",
      "range": {
        "startLine": 24,
        "startChar": 0,
        "endLine": 25,
        "endChar": 35
      },
      "revId": "e663686b60d15504861740b0a1e0397e40759ae7",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "d746c554_65a9563a",
        "filename": "target/board/BoardConfigEmuCommon.mk",
        "patchSetId": 17
      },
      "lineNbr": 25,
      "author": {
        "id": 1046320
      },
      "writtenOn": "2019-04-12T17:16:57Z",
      "side": 1,
      "message": "I guess I will have to modify how the super.img is made for emulator.",
      "parentUuid": "a6225c18_c8493a16",
      "range": {
        "startLine": 24,
        "startChar": 0,
        "endLine": 25,
        "endChar": 35
      },
      "revId": "e663686b60d15504861740b0a1e0397e40759ae7",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c58dbfad_fa7ad852",
        "filename": "target/board/BoardConfigEmuCommon.mk",
        "patchSetId": 17
      },
      "lineNbr": 25,
      "author": {
        "id": 1080813
      },
      "writtenOn": "2019-04-12T17:22:16Z",
      "side": 1,
      "message": "Oh, I see.\n\nBefore DAP:\n  1. Build system doesn\u0027t need to know _a/_b.\n  2. It can just build one copy of images: $OUT/system.img, $OUT/vendor.img, etc. (but not system_a.img, vendor_a.img).\n  3.For which slot (_a or _b) to flash to, it can be decided at flash time.\n\nAfter DAP (IIRC):\n  1. no physical _a _b slot, but only a single /super\n  2. system_a.img, system_b.img, etc will be placed on /super\n  3. This is more space-efficient as both slots can share the large /super partition, without splitting to two physical /super_a, /super_b.\n \nSeveral solutions on top of my head now:\n1) Create no _a / _b logical partitions if there is no ro.boot.slot_suffix.\n\n[    1.152893] init: [libfs_mgr]Created logical partition *system* on device /dev/block/dm-0\n[    1.168029] init: [libfs_mgr]Created logical partition *vendor* on device /dev/block/dm-1\n..\n\nOR\n\n2) Emulator adds ro.boot.slot_suffix\u003d_a for it.\n   DM_DEV_STATUS failed for *system*: No such device or address  \u003c\u003d\u003d then this might become \u0027system_a\u0027 and no failure ?\n\nOR\n\n3) Use AB_OTA_PARTITIONS instead of AB_OTA_UPDATER in lpmake to decide if a device is A/B or not. In emulator/GSI we can probably unset AB_OTA_PARTITIONS as there is no need to run OTA flow in both GSI and emulator?",
      "parentUuid": "a6225c18_c8493a16",
      "range": {
        "startLine": 24,
        "startChar": 0,
        "endLine": 25,
        "endChar": 35
      },
      "revId": "e663686b60d15504861740b0a1e0397e40759ae7",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c41b079a_66a2f42a",
        "filename": "target/board/BoardConfigEmuCommon.mk",
        "patchSetId": 17
      },
      "lineNbr": 25,
      "author": {
        "id": 1046320
      },
      "writtenOn": "2019-04-12T18:20:37Z",
      "side": 1,
      "message": "It seems more straight forward to change the logic of lpmake to use\nAB_OTA_PARTITIONS instead of AB_OTA_UPDATER\n\nupdated the cl and it boots",
      "parentUuid": "c58dbfad_fa7ad852",
      "range": {
        "startLine": 24,
        "startChar": 0,
        "endLine": 25,
        "endChar": 35
      },
      "revId": "e663686b60d15504861740b0a1e0397e40759ae7",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "37d13103_8fc0368c",
        "filename": "target/board/BoardConfigEmuCommon.mk",
        "patchSetId": 17
      },
      "lineNbr": 25,
      "author": {
        "id": 1046320
      },
      "writtenOn": "2019-04-12T18:52:03Z",
      "side": 1,
      "message": "I found another issue: there is this ro.build.ab_update\u003dtrue and it is preventing\nremount from working\n\n1|generic_x86:/system # remount\nW DM_DEV_STATUS failed for scratch: No such device or address\nE [liblp]Unsuffixed partition not allowed on A/B device: system\nE [libfs_mgr]open /dev/block/by-name/super metadata\nE Overlayfs setup for /system failed, skipping: No such file or directory\nW DM_DEV_STATUS failed for scratch: No such device or address\nE [liblp]Unsuffixed partition not allowed on A/B device: system\nE [libfs_mgr]open /dev/block/by-name/super metadata\nE Overlayfs setup for /vendor failed, skipping: No such file or directory\nW No partitions to remount",
      "parentUuid": "c41b079a_66a2f42a",
      "range": {
        "startLine": 24,
        "startChar": 0,
        "endLine": 25,
        "endChar": 35
      },
      "revId": "e663686b60d15504861740b0a1e0397e40759ae7",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "1b5b8e1a_2a4def01",
        "filename": "target/board/BoardConfigEmuCommon.mk",
        "patchSetId": 17
      },
      "lineNbr": 25,
      "author": {
        "id": 1046320
      },
      "writtenOn": "2019-04-12T19:23:32Z",
      "side": 1,
      "message": "I switched to a/b, the mounting errors are gone but\nthen updater is rebooting my device\n[    1.182770] init: [libfs_mgr]ReadFstabFromDt(): failed to read fstab from dt\n[    1.184865] init: Using Android DT directory /proc/device-tree/firmware/android/\n[    1.204458] init: [libfs_mgr]Created logical partition system_a on device /dev/block/dm-0\n[    1.205848] init: [libfs_mgr]Skipping zero-length logical partition: system_b\n[    1.222189] init: [libfs_mgr]Created logical partition vendor_a on device /dev/block/dm-1\n[    1.225393] init: [libfs_mgr]Skipping zero-length logical partition: vendor_b\n[    1.231494] init: [libfs_avb]Returning avb_handle with status: VerificationDisabled\n[    1.233079] init: [libfs_avb]AVB HASHTREE disabled on: /system\n[    1.234615] init: [libfs_mgr]superblock s_max_mnt_count:65535,/dev/block/dm-0\n[    1.249113] EXT4-fs (dm-0): mounted filesystem without journal. Opts: barrier\u003d1\n[    1.257013] EXT4-fs (dm-1): mounted filesystem without journal. Opts: barrier\u003d1\n\n[    2.362753] fscrypt: AES-256-XTS using implementation \"xts(ecb(aes-asm))\"\n[    2.393183] update_verifier: Started with arg 1: nonencrypted\n[    2.395465] update_verifier: Error getting bootctrl module.\n\n\nhttps://cs.corp.google.com/android/bootable/recovery/update_verifier/update_verifier.cpp?q\u003dupdate_verifier+package:%5Eandroid$\u0026dr\u003dCSs\u0026l\u003d313",
      "parentUuid": "37d13103_8fc0368c",
      "range": {
        "startLine": 24,
        "startChar": 0,
        "endLine": 25,
        "endChar": 35
      },
      "revId": "e663686b60d15504861740b0a1e0397e40759ae7",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "e0e1f0ce_53d24140",
        "filename": "target/board/BoardConfigEmuCommon.mk",
        "patchSetId": 17
      },
      "lineNbr": 25,
      "author": {
        "id": 1056365
      },
      "writtenOn": "2019-04-12T19:37:00Z",
      "side": 1,
      "message": "update_verifier should not get that far, as it checks `ro.boot.slot_suffix` upon start:\nhttps://cs.corp.google.com/android/bootable/recovery/update_verifier/update_verifier_main.cpp?dr\u003dCSs\u0026g\u003d0\u0026l\u003d30\n\nThat flag is passed by bootloader on regular devices. Do we have non-empty value on emulator?",
      "parentUuid": "1b5b8e1a_2a4def01",
      "range": {
        "startLine": 24,
        "startChar": 0,
        "endLine": 25,
        "endChar": 35
      },
      "revId": "e663686b60d15504861740b0a1e0397e40759ae7",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    }
  ]
}